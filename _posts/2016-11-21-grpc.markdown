---
layout: post
title:  "grpc使用学习"
date:   2016-11-21 11:21:23 +0800
description: 
categories: Home
---

grpc使用学习

---

官方的看起来有点复杂, 自己实践一下具体的操作流程.

###服务端配置:

1、安装`protoc`

首先下载`protoc 3.1`, 地址[https://github.com/google/protobuf/releases](https://github.com/google/protobuf/releases), 下载完成以后放入`usr/local`文件夹里面.

打开终端输入`nano .bash_profile`, 然后在Path后面加上 `:/usr/local/protoc-3/bin`, 保存退出. 

继续输入 `source .bash_profile`使修改立即生效.

最后输入 `protoc --version`, 如果提示 libprotoc 3.1.0 则说明安装成功.

2、创建一个`.proto`文件

```go
syntax = "proto3"; //这里使用proto3的语法规则

package helloworld;

// 定义服务
service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

// 客户端传的名字
message HelloRequest {
  string name = 1;
}

// 服务端返回的消息
message HelloReply {
  string message = 1;
}
```

3、生成Server side代码

打开终端 cd 到第二步新建的proto文件目录输入: `protoc --go_out=plugins=grpc:. helloWorld.proto` 会在这个目录下生成一个`helloWorld.pb.go`文件

4、实现刚才生成的代码并且创建一个grpc服务

写一个`main.go`文件

```go
package main

import (
	hw "grpcHalloWorld/helloworld"
	"log"

	"net"

	"golang.org/x/net/context"
	"google.golang.org/grpc"
)

type server struct{}

const (
	port = ":8383"
)

func (s *server) SayHello(ctx context.Context, in *hw.HelloRequest) (*hw.HelloReply, error) {
	return &hw.HelloReply{Message: "Hello world!!"}, nil
}

func main() {
	lis, err := net.Listen("tcp", port)
	if err != nil {
		log.Fatalf("failed to listen: %v", err)
	}
	s := grpc.NewServer()
	hw.RegisterGreeterServer(s, &server{})
	if err := s.Serve(lis); err != nil {
		log.Fatalf("failed to serve: %v", err)
	}
}
```

然后build一下, 生成二进制文件, 上传到自己的服务器上面执行.
我已经传到我的服务器了, 地址是`155.94.146.125:8383`, 可以进行测试

### 客户端配置

1、新建一个新的Swift项目

具体过程略过

2、创建一个`. podspec`文件

我们通过这个来管理和生成grpc的客户端文件以及grpc需要的依赖库.

```swift
Pod::Spec.new do |s|
  s.name     = "grpcService"
  s.version  = "0.0.2"
  s.license  = "New BSD"
  s.authors  = { 'gRPC contributors' => 'grpc-io@googlegroups.com' }
  s.homepage = "http://www.grpc.io/"
  s.summary = "HelloWorld example"
  s.source = { :git => 'https://github.com/grpc/grpc.git' }

  s.ios.deployment_target = "8.0"
  s.osx.deployment_target = "10.9"

  # Base directory where the .proto files are.
  src = "./grpcSwift"

  # Run protoc with the Objective-C and gRPC plugins to generate protocol messages and gRPC clients.
  s.dependency "!ProtoCompiler-gRPCPlugin", "~> 1.0"

  # Pods directory corresponding to this app's Podfile, relative to the location of this podspec.
  pods_root = 'Pods'

  # Path where Cocoapods downloads protoc and the gRPC plugin.
  protoc_dir = "#{pods_root}/!ProtoCompiler"
  protoc = "#{protoc_dir}/protoc"
  plugin = "#{pods_root}/!ProtoCompiler-gRPCPlugin/grpc_objective_c_plugin"

  # Directory where the generated files will be placed.
  dir = "#{pods_root}/#{s.name}"

  s.prepare_command = <<-CMD
    mkdir -p #{dir}
    #{protoc} \
        --plugin=protoc-gen-grpc=#{plugin} \
        --objc_out=#{dir} \
        --grpc_out=#{dir} \
        -I #{src} \
        -I #{protoc_dir} \
        #{src}/helloworld.proto
  CMD

  # Files generated by protoc
  s.subspec "Messages" do |ms|
    ms.source_files = "#{dir}/*.pbobjc.{h,m}", "#{dir}/**/*.pbobjc.{h,m}"
    ms.header_mappings_dir = dir
    ms.requires_arc = false
    # The generated files depend on the protobuf runtime.
    ms.dependency "Protobuf"
  end

  # Files generated by the gRPC plugin
  s.subspec "Services" do |ss|
    ss.source_files = "#{dir}/*.pbrpc.{h,m}", "#{dir}/**/*.pbrpc.{h,m}"
    ss.header_mappings_dir = dir
    ss.requires_arc = true
    # The generated files depend on the gRPC runtime, and on the files generated by protoc.
    ss.dependency "gRPC-ProtoRPC"
    ss.dependency "#{s.name}/Messages"
  end

  s.pod_target_xcconfig = {
    # This is needed by all pods that depend on Protobuf:
    'GCC_PREPROCESSOR_DEFINITIONS' => '$(inherited) GPB_USE_PROTOBUF_FRAMEWORK_IMPORTS=1',
    # This is needed by all pods that depend on gRPC-RxLibrary:
    'CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES' => 'YES',
  }
end
```

3、新建一个`Podfile`

```swift
source 'https://github.com/CocoaPods/Specs.git'

platform:ios,'8.0'
use_frameworks!
inhibit_all_warnings!

target 'grpcSwift' do

    pod 'grpcService', :path => '.'

end
```

弄完以后`pod install`, 等一会pod完成以后`grpc`的客户端就安装进项目了

4、测试和服务器端的链接

在Appdelegate里面写写测试代码来试一下

```swift
import UIKit
import GRPCClient
import grpcService

@UIApplicationMain
class AppDelegate: UIResponder, UIApplicationDelegate {

    var window: UIWindow?


    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?) -> Bool {
        
        
        GRPCCall.useInsecureConnections(forHost: "155.94.146.125:8383")
//        GRPCCall.setUserAgentPrefix("grpcSwift", forHost: "155.94.146.125:8383")
        
       let g = Greeter(host: "155.94.146.125:8383")
        
        
        let request = HelloRequest()
        request.name = "111"
        
        g.sayHello(with: request) { (reply, err) in
            
            print(reply?.message, err?.localizedDescription)
        }
        
        g.sayHello(with: request) { (reply, err) in
            
            print(reply?.message, err?.localizedDescription)
        }
        
        let r = g.rpcToSayHello(with: request) { (reply, err) in
            
            print(reply?.message, err?.localizedDescription)
        }
        
        r.start()
        
        return true
    }
}
```

如果输出控制台可以正确输出

```swift
Optional("Hello world!!") nil
Optional("Hello world!!") nil
Optional("Hello world!!") nil
```
说明我们的grpc就请求成功了.

以上代码已经全部上传到GitHub了, 可以下载查看
[https://github.com/570262616/grpcHelloWorld](https://github.com/570262616/grpcHelloWorld)


